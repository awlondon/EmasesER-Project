<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/png" href="./favicon.png" />

    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, interactive-widget=resizes-content"
    />

    <title>Emases</title>

    <!-- PATCHES FIRST (disable Sentry, override navigator, block telemetry) -->
    <script src="./scripts/patch.js" defer></script>
    <script src="./scripts/proxy.js" defer></script>

    <!-- SESAME CORE BUNDLE -->
    <script type="module" src="./assets/index.js" defer></script>
    
    <!-- DEV PANEL (optional toggle UI) -->
    <script src="./assets/dev-panel.js" defer></script>
    
    <!-- STYLESHEETS -->
    <link rel="stylesheet" href="./assets/index.css" />
    <link rel="stylesheet" href="./styles/custom.css" />
    

    <!-- INLINE STYLES -->
    <style>
      #theme-toggle:hover {
        background: var(--color-accent);
      }
    </style>
  </head>

  <body>
    <button
      id="theme-toggle"
      style="position: fixed; top: 1rem; right: 1rem; background: var(--color-primary); color: var(--color-text);"
    >
      Toggle Theme
    </button>

    <div id="root"></div>

    <!-- Theme toggle JS -->
    <script>
      const toggleBtn = document.getElementById('theme-toggle');
      if (toggleBtn) {
        toggleBtn.addEventListener('click', () => {
          document.documentElement.classList.toggle('dark');
        });
      }
    </script>

    <!-- LIVE SERVER INJECTION (Only needed during dev) -->
    <script type="text/javascript">
      if ('WebSocket' in window) {
        (function () {
          function refreshCSS() {
            const sheets = Array.from(document.getElementsByTagName("link"));
            const head = document.head;
            for (const elem of sheets) {
              head.removeChild(elem);
              if (
                elem.href &&
                (!elem.rel || elem.rel.toLowerCase() === "stylesheet")
              ) {
                const url = elem.href.replace(/(&|\?)_cacheOverride=\d+/, "");
                elem.href =
                  url +
                  (url.includes("?") ? "&" : "?") +
                  "_cacheOverride=" +
                  new Date().valueOf();
              }
              head.appendChild(elem);
            }
          }
          const protocol = window.location.protocol === "http:" ? "ws://" : "wss://";
          const address = protocol + window.location.host + window.location.pathname + "/ws";
          const socket = new WebSocket(address);
          socket.onmessage = function (msg) {
            if (msg.data === "reload") window.location.reload();
            else if (msg.data === "refreshcss") refreshCSS();
          };
          console.log("Live reload enabled.");
        })();
      }
    </script>
  </body>
</html>
